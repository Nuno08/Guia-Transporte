<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">Home</a>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="text-center">Selecione os Produtos</h2>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Descrição</th>
                    <th>Quantidade</th>
                </tr>
            </thead>
            <tbody id="ListaProdutos"></tbody>
        </table>

        <button class="btn btn-success" onclick="Pedido()">Confirmar Pedido</button>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://joootssfsyqruiflpfib.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impvb290c3Nmc3lxcnVpZmxwZmliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMyNjY2NjcsImV4cCI6MjA1ODg0MjY2N30.Cx4fqgC-PVy2vud4kNUhaJrJvKGZCjae76VSqxxLXvI';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function carregarProdutos() {
            const { data, error } = await supabase.from('Produto').select('*');
            if (error) {
                console.error('Erro ao buscar produtos:', error);
                return;
            }

            const tabela = document.getElementById("ListaProdutos");
            tabela.innerHTML = '';

            data.forEach(produto => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${produto.CodProduto}</td>
                    <td>${produto.Descricao}</td>
                    <td><input type="number" min="0" value="0" id="Quantidade-${produto.CodProduto}" class="form-control" style="width: 80px;"></td>
                `;
                tabela.appendChild(row);
            });
        }
        document.addEventListener("DOMContentLoaded", () => {
    document.querySelector("button").onclick = Pedido;
});

        async function Pedido() {
            const { data: produtos, error } = await supabase.from('Produto').select('*');
            if (error) {
                console.error('Erro ao buscar produtos:', error);
                return;
            }
            let produtosSelecionados = [];
            let temProdutoSelecionado = false;  // Para verificar se algum produto foi selecionado

            produtos.forEach(produto => {
                const Quantidade = document.getElementById(`Quantidade-${produto.CodProduto}`).value;
                
                if (Quantidade > 0 || Quantidade === "0") {
                    temProdutoSelecionado = true;  // Produto selecionado
                    produtosSelecionados.push({
                        CodProduto: produto.CodProduto,
                        Descricao: produto.Descricao,
                        Quantidade: parseInt(Quantidade)
                    });
                }
            });

            // Verifique se pelo menos um produto foi selecionado
            if (!temProdutoSelecionado) {
                alert("Por favor, selecione pelo menos um produto com quantidade maior que 0.");
                return;
            }

            const { error: upsertError } = await supabase
            .from('Produto')
            .upsert(produtosSelecionados, { onConflict: ['CodProduto'] });

            if (upsertError) {
            console.error('Erro ao salvar pedido:', upsertError);
            return;
            }

            localStorage.setItem('produtosSelecionados', JSON.stringify(produtosSelecionados));
            alert("Pedido confirmado!");
            window.location.href = 'entrega.html';
        }

        carregarProdutos();
    </script>
</body>
</html>