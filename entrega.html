<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrega</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://joootssfsyqruiflpfib.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impvb290c3Nmc3lxcnVpZmxwZmliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMyNjY2NjcsImV4cCI6MjA1ODg0MjY2N30.Cx4fqgC-PVy2vud4kNUhaJrJvKGZCjae76VSqxxLXvI';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let produtosSelecionados = [];
        async function carregarProdutos() {
            const { data, error } = await supabase
            .from('Produto')
            .select('*')
            .gt('Quantidade', 0);
            if (error) {
                console.error('Erro ao buscar produtos:', error);
                return;
            }

            const tabela = document.getElementById("ListaProdutos");
            tabela.innerHTML = '';

            // Preencher a tabela com os produtos
            data.forEach(produto => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${produto.CodProduto}</td>
                    <td>${produto.Descricao}</td>
                    <td>${produto.Quantidade}</td>
                `;
                tabela.appendChild(row);
            });
        }

        async function salvarEntrega() {
            const tabela = document.getElementById("ListaProdutos");
            produtosSelecionados = [];
            const rows = tabela.getElementsByTagName("tr");

            for (let row of rows) {
                const codProduto = row.cells[0].innerText;
                const quantidade = parseInt(row.cells[2].innerText);
                // Só adicionar o produto se a quantidade for maior que 0
                if (quantidade > 0) {
                    produtosSelecionados.push({
                        CodProduto: codProduto,
                        Quantidade: quantidade
                    });
                }
            }

            const entrega = {
                observacoes: document.getElementById('Observacoes').value,
                LocalCarga: document.getElementById('Carga').value,
                LocalDescarga: document.getElementById('Descarga').value,
                CidadeCarga: document.getElementById('CidadeCarga').value,
                CidadeDescarga: document.getElementById('CidadeDescarga').value,
                DataHoraCarga: document.getElementById('DataHoraCarga').value,
                DataHoraDescarga: document.getElementById('DataHoraDescarga').value,
                Matricula: document.getElementById('Matricula').value
            };

            const { error } = await supabase.from('Entrega').insert([entrega]);
            if (error) {
                console.error('Erro ao salvar entrega:', error);
                return;
            }
            gerarPDF(entrega);
        }

        async function gerarPDF(entrega) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.text("Empresa Demonstrativa, Lda", 20, 20);
            doc.setFontSize(12);
            doc.text("Rua teste", 20, 30);
            doc.text("4123-123 Cidade da Loja, Portugal", 20, 40);
            doc.text("email@empresa.com | Tel: 222 220 220", 20, 50);

            doc.setFontSize(14);
            doc.text("Guia de Transporte", 140, 20);
            doc.setFontSize(12);
            doc.text("Número: 2025/32", 140, 30);
            doc.text("Data/Hora: 2025-02-26 11:16:07", 140, 40);
            doc.text("Via Original", 140, 50);

            doc.setFillColor(0);
            doc.setTextColor(255);
            doc.rect(20, 60, 170, 10, "F");
            doc.text("Cliente Nº 34", 25, 67);
            doc.setTextColor(0);
            doc.text("Cliente empresa", 20, 75);
            doc.text("Rua Teste 2", 20, 85);
            doc.text("4000-208 Porto, Portugal", 20, 95);

            doc.setFont("helvetica", "bold");
            doc.text("Cod.", 20, 110);
            doc.text("Descrição", 40, 110);
            doc.text("Quant.", 110, 110);

            let yPosition = 120; // Posição inicial para os produtos no PDF

            // Loop para adicionar os produtos ao PDF
            for (const produto of produtosSelecionados) {
                // Buscar a descrição do produto
                const { data: produtoInfo, error } = await supabase
                    .from('Produto')
                    .select('*')
                    .eq('CodProduto', produto.CodProduto)
                    .single();

                if (error) {
                    console.error('Erro ao buscar informações do produto:', error);
                    continue;
                }

                // Adiciona os dados do produto ao PDF
                doc.text(produto.CodProduto, 20, yPosition);
                doc.text(produtoInfo.Descricao, 40, yPosition);
                doc.text(produto.Quantidade.toString(), 110, yPosition);

                // Atualiza a posição no PDF para o próximo produto
                yPosition += 10;
            }



            doc.text(`Observações: ${entrega.observacoes}`, 20, 140);
            doc.text(`Carga: ${entrega.LocalCarga}, ${entrega.CidadeCarga} ${entrega.DataHoraCarga}`, 20, 150);
            doc.text(`Descarga: ${entrega.LocalDescarga}, ${entrega.CidadeDescarga} ${entrega.DataHoraDescarga}`, 20, 160);
            doc.text(`Matrícula: ${entrega.Matricula}`, 20, 170);

            doc.save("guia_transporte.pdf");
        }


        document.addEventListener("DOMContentLoaded", () => {
            carregarProdutos();

            document.querySelector("button").addEventListener("click", salvarEntrega);
        });    
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">Home</a>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="text-center">Confirme seu Pedido</h2>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Descrição</th>
                    <th>Quantidade</th>
                </tr>
            </thead>
            <tbody id="ListaProdutos"></tbody>
        </table>

        <h3>Informações de Entrega</h3>
        <form id="deliveryDetailsForm">
            <div class="mb-3">
                <label for="Observacoes" class="form-label">Observações</label>
                <input type="text" class="form-control" id="Observacoes" required>
            </div>
            <div class="mb-3">
                <label for="Carga" class="form-label">Local de Carga</label>
                <input type="text" class="form-control" id="Carga" required>
            </div>
            <div class="mb-3">
                <label for="Descarga" class="form-label">Local de Descarga</label>
                <input type="text" class="form-control" id="Descarga" required>
            </div>
            <div class="mb-3">
                <label for="CidadeCarga" class="form-label">Cidade de Carga</label>
                <input type="text" class="form-control" id="CidadeCarga" required>
            </div>
            <div class="mb-3">
                <label for="CidadeDescarga" class="form-label">Cidade de Descarga</label>
                <input type="text" class="form-control" id="CidadeDescarga" required>
            </div>
            <div class="mb-3">
                <label for="DataHoraCarga" class="form-label">Data e Hora de Carga</label>
                <input type="datetime-local" class="form-control" id="DataHoraCarga" required>
            </div>
            <div class="mb-3">
                <label for="DataHoraDescarga" class="form-label">Data e Hora de Descarga</label>
                <input type="datetime-local" class="form-control" id="DataHoraDescarga" required>
            </div>
            <div class="mb-3">
                <label for="Matricula" class="form-label">Matrícula do Veículo</label>
                <input type="text" class="form-control" id="Matricula" required>
            </div>
            <button type="button" class="btn btn-primary" onclick="salvarEntrega()">Confirmar Pedido</button>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
